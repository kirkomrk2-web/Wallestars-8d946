name: Agent Monitoring & Health Check

on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä–∏ –∞–≥–µ–Ω—Ç–∏—Ç–µ –Ω–∞ –≤—Å–µ–∫–∏ 10 –º–∏–Ω—É—Ç–∏
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  monitor-agents:
    runs-on: ubuntu-latest
    name: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ –∞–≥–µ–Ω—Ç–∏
    env:
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç –Ω–∞ –∞–≥–µ–Ω—Ç–∏—Ç–µ
        id: check_agents
        uses: actions/github-script@v7
        with:
          script: |
            const agents = ['copilot-agent-1', 'copilot-agent-2', 'copilot-agent-3', 'copilot-agent-4'];
            const agentStatus = {};
            
            // –ü—Ä–æ–≤–µ—Ä–∏ PR-–æ–≤–µ –∑–∞ –≤—Å–µ–∫–∏ –∞–≥–µ–Ω—Ç
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const agent of agents) {
              const agentPRs = pullRequests.filter(pr => 
                pr.labels.some(label => label.name === `agent:${agent}`)
              );
              
              // –ü—Ä–æ–≤–µ—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∞—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç
              let lastActivity = null;
              let isActive = false;
              
              for (const pr of agentPRs) {
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number
                });
                
                const agentComments = comments.filter(c => 
                  c.body.includes(agent) || c.user.login.includes('bot')
                );
                
                if (agentComments.length > 0) {
                  const latestComment = agentComments[agentComments.length - 1];
                  const commentDate = new Date(latestComment.created_at);
                  const now = new Date();
                  const hoursSinceActivity = (now - commentDate) / (1000 * 60 * 60);
                  
                  if (hoursSinceActivity < 1) {
                    isActive = true;
                  }
                  
                  if (!lastActivity || commentDate > new Date(lastActivity)) {
                    lastActivity = latestComment.created_at;
                  }
                }
              }
              
              agentStatus[agent] = {
                assigned_prs: agentPRs.length,
                last_activity: lastActivity,
                is_active: isActive,
                status: isActive ? 'üü¢ Active' : 'üü° Idle'
              };
            }
            
            // –°—ä–∑–¥–∞–π summary
            let summary = `## ü§ñ –°—Ç–∞—Ç—É—Å –Ω–∞ –∞–≥–µ–Ω—Ç–∏—Ç–µ\\n\\n`;
            summary += `**–í—Ä–µ–º–µ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞:** ${new Date().toISOString()}\\n\\n`;
            summary += `| –ê–≥–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏ PR-–æ–≤–µ | –ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç | –°—Ç–∞—Ç—É—Å |\\n`;
            summary += `|---|---|---|---|\\n`;
            
            for (const [agent, status] of Object.entries(agentStatus)) {
              summary += `| ${agent} | ${status.assigned_prs} | ${status.last_activity || '–ù—è–º–∞'} | ${status.status} |\\n`;
            }
            
            await core.summary.addRaw(summary).write();
            
            // –ò–∑–ø—Ä–∞—Ç–∏ –∫—ä–º n8n
            await fetch(`${process.env.N8N_WEBHOOK_URL}/webhook/agent-status`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                agents: agentStatus,
                timestamp: new Date().toISOString()
              })
            });

  check-stale-prs:
    runs-on: ubuntu-latest
    name: –ü—Ä–æ–≤–µ—Ä–∏ —Å—Ç–∞—Ä–∏ PR-–æ–≤–µ
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞–π —Å—Ç–∞—Ä–∏ PR-–æ–≤–µ
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            
            for (const pr of pullRequests) {
              const updatedAt = new Date(pr.updated_at);
              
              if (updatedAt < twoDaysAgo) {
                // –î–æ–±–∞–≤–∏ stale label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['stale', 'needs-attention']
                });
                
                // –°—ä–∑–¥–∞–π –∫–æ–º–µ–Ω—Ç–∞—Ä
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `‚ö†Ô∏è **Stale PR Alert**\n\n–¢–æ–∑–∏ PR –Ω—è–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç –ø–æ–≤–µ—á–µ –æ—Ç 2 –¥–Ω–∏.\n\n**–ú–æ–ª—è:**\n- –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π PR\n- –û—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏\n- –∏–ª–∏ –∑–∞—Ç–≤–æ—Ä–∏ PR –∞–∫–æ –Ω–µ –µ –∞–∫—Ç—É–∞–ª–µ–Ω\n\n---\n_–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–æ –æ—Ç Agent Monitoring System_`
                });
                
                console.log(`‚ö†Ô∏è Marked PR #${pr.number} as stale`);
              }
            }

  create-daily-report:
    runs-on: ubuntu-latest
    name: –î–Ω–µ–≤–µ–Ω –¥–æ–∫–ª–∞–¥
    if: github.event.schedule == '0 9 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –¥–Ω–µ–≤–µ–Ω –¥–æ–∫–ª–∞–¥
        uses: actions/github-script@v7
        with:
          script: |
            const oneDayAgo = new Date();
            oneDayAgo.setDate(oneDayAgo.getDate() - 1);
            
            const { data: allPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            const recentPRs = allPRs.filter(pr => 
              new Date(pr.updated_at) > oneDayAgo
            );
            
            const openPRs = recentPRs.filter(pr => pr.state === 'open');
            const closedPRs = recentPRs.filter(pr => pr.state === 'closed' && pr.merged_at);
            
            const reportBody = [
              `# üìä –î–Ω–µ–≤–µ–Ω –¥–æ–∫–ª–∞–¥ –∑–∞ –∞–≥–µ–Ω—Ç–∏ - ${new Date().toLocaleDateString('bg-BG')}`,
              '',
              '## –û–±–æ–±—â–µ–Ω–∏–µ',
              `- **–û—Ç–≤–æ—Ä–µ–Ω–∏ PR-–æ–≤–µ:** ${openPRs.length}`,
              `- **Merge-–Ω–∞—Ç–∏ PR-–æ–≤–µ:** ${closedPRs.length}`,
              `- **–û–±—â–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç:** ${recentPRs.length}`,
              '',
              '## –û—Ç–≤–æ—Ä–µ–Ω–∏ PR-–æ–≤–µ',
              ...openPRs.map(pr => `- #${pr.number} - ${pr.title} (${pr.user.login})`),
              '',
              '## Merge-–Ω–∞—Ç–∏ PR-–æ–≤–µ',
              ...closedPRs.map(pr => `- ‚úÖ #${pr.number} - ${pr.title} (${pr.user.login})`),
              '',
              '---',
              '_–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–æ –æ—Ç Agent Monitoring System_'
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä –î–Ω–µ–≤–µ–Ω –¥–æ–∫–ª–∞–¥ - ${new Date().toLocaleDateString('bg-BG')}`,
              body: reportBody,
              labels: ['report', 'automated']
            });
