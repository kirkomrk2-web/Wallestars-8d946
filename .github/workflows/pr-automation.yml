name: PR Automation & Agent Delegation

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]
  pull_request_review:
    types: [submitted]
  schedule:
    # –ü—Ä–æ–≤–µ—Ä–∏ PR-–æ–≤–µ –Ω–∞ –≤—Å–µ–∫–∏ 15 –º–∏–Ω—É—Ç–∏
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  delegate-to-agents:
    runs-on: ubuntu-latest
    name: –î–µ–ª–µ–≥–∏—Ä–∞–Ω–µ –Ω–∞ PR –∫—ä–º –∞–≥–µ–Ω—Ç–∏
    env:
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –í–∑–µ–º–∏ –æ—Ç–≤–æ—Ä–µ–Ω–∏ PR-–æ–≤–µ
        id: get_prs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            core.setOutput('prs', JSON.stringify(pullRequests));
            core.setOutput('count', pullRequests.length);
            
            // –°—ä–∑–¥–∞–π summary
            let summary = `## üìä –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –æ—Ç–≤–æ—Ä–µ–Ω–∏ PR-–æ–≤–µ\n\n`;
            summary += `**–ë—Ä–æ–π –æ—Ç–≤–æ—Ä–µ–Ω–∏ PR-–æ–≤–µ:** ${pullRequests.length}\n\n`;
            
            if (pullRequests.length > 0) {
              summary += `| PR | –ê–≤—Ç–æ—Ä | –°—Ç–∞—Ç—É—Å | –ê–≥–µ–Ω—Ç |\n`;
              summary += `|---|---|---|---|\n`;
              
              for (const pr of pullRequests) {
                const labels = pr.labels.map(l => l.name).join(', ');
                const agent = labels.includes('agent:') ? 
                  labels.split('agent:')[1]?.split(',')[0]?.trim() || '–ù—è–º–∞' : '–ù—è–º–∞';
                summary += `| #${pr.number} | @${pr.user.login} | ${pr.draft ? 'üìù Draft' : '‚úÖ Ready'} | ${agent} |\n`;
              }
            }
            
            await core.summary.addRaw(summary).write();

      - name: –î–µ–ª–µ–≥–∏—Ä–∞–π PR –±–µ–∑ –∞–≥–µ–Ω—Ç
        uses: actions/github-script@v7
        env:
          PRS_JSON: ${{ steps.get_prs.outputs.prs }}
        with:
          script: |
            const pullRequests = JSON.parse(process.env.PRS_JSON);
            const agents = ['copilot-agent-1', 'copilot-agent-2', 'copilot-agent-3', 'copilot-agent-4'];
            let agentIndex = 0;
            
            for (const pr of pullRequests) {
              // –ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ PR –∏–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–≥–µ–Ω—Ç
              const hasAgent = pr.labels.some(label => label.name.startsWith('agent:'));
              
              if (!hasAgent && !pr.draft) {
                // –ù–∞–∑–Ω–∞—á–∏ –∞–≥–µ–Ω—Ç –ø–æ —Ä–æ—Ç–∞—Ü–∏—è
                const assignedAgent = agents[agentIndex % agents.length];
                agentIndex++;
                
                // –î–æ–±–∞–≤–∏ label —Å –∞–≥–µ–Ω—Ç
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: [`agent:${assignedAgent}`, 'automated']
                });
                
                // –°—ä–∑–¥–∞–π –∫–æ–º–µ–Ω—Ç–∞—Ä —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `ü§ñ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–µ–ª–µ–≥–∏—Ä–∞–Ω–µ**\n\n–¢–æ–∑–∏ PR –µ –¥–µ–ª–µ–≥–∏—Ä–∞–Ω –∫—ä–º: \`${assignedAgent}\`\n\n**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞ –∞–≥–µ–Ω—Ç–∞:**\n- [ ] –ù–∞–ø—Ä–∞–≤–∏ code review\n- [ ] –ü—Ä–æ–≤–µ—Ä–∏ –∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∏\n- [ ] –¢–µ—Å—Ç–≤–∞–π –ø—Ä–æ–º–µ–Ω–∏—Ç–µ\n- [ ] –û–¥–æ–±—Ä–∏ –∏–ª–∏ –ø–æ–∏—Å–∫–∞–π –ø—Ä–æ–º–µ–Ω–∏\n\n**–°—Ç–∞—Ç—É—Å:** üîÑ –í –ø—Ä–æ—Ü–µ—Å –Ω–∞ —Ä–µ–≤—é\n\n---\n_–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–æ –æ—Ç GitHub Actions_`
                });
                
                // –ò–∑–ø—Ä–∞—Ç–∏ webhook –∫—ä–º n8n
                await fetch(`${process.env.N8N_WEBHOOK_URL}/webhook/pr-delegated`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    pr_number: pr.number,
                    pr_title: pr.title,
                    agent: assignedAgent,
                    url: pr.html_url,
                    timestamp: new Date().toISOString()
                  })
                });
                
                console.log(`‚úÖ –î–µ–ª–µ–≥–∏—Ä–∞–Ω PR #${pr.number} –∫—ä–º ${assignedAgent}`);
              }
            }

  auto-review:
    runs-on: ubuntu-latest
    name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω code review
    needs: delegate-to-agents
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π dependencies
        run: npm ci --legacy-peer-deps

      - name: –ù–∞–ø—Ä–∞–≤–∏ automated review
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const pr of pullRequests) {
              // –í–∑–µ–º–∏ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ –≤ PR
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });
              
              let reviewComments = [];
              let hasIssues = false;
              
              // –ü—Ä–æ–≤–µ—Ä–∏ –∑–∞ –æ–±—â–∏ –ø—Ä–æ–±–ª–µ–º–∏
              for (const file of files) {
                if (file.filename.endsWith('.jsx') || file.filename.endsWith('.js')) {
                  if (file.patch && file.patch.includes('console.log')) {
                    hasIssues = true;
                    reviewComments.push({
                      path: file.filename,
                      body: '‚ö†Ô∏è –ù–∞–º–µ—Ä–µ–Ω console.log - –ø—Ä–µ–º–∞—Ö–Ω–∏ –ø—Ä–µ–¥–∏ merge',
                      line: 1
                    });
                  }
                  
                  if (file.patch && file.patch.includes('debugger')) {
                    hasIssues = true;
                    reviewComments.push({
                      path: file.filename,
                      body: 'üõë –ù–∞–º–µ—Ä–µ–Ω debugger statement - –ø—Ä–µ–º–∞—Ö–Ω–∏ –ø—Ä–µ–¥–∏ merge',
                      line: 1
                    });
                  }
                }
              }
              
              // –ê–∫–æ –∏–º–∞ –ø—Ä–æ–±–ª–µ–º–∏, –ø–æ–∏—Å–∫–∞–π –ø—Ä–æ–º–µ–Ω–∏
              if (hasIssues) {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  event: 'REQUEST_CHANGES',
                  body: 'ü§ñ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω Code Review**\n\n–ù–∞–º–µ—Ä–µ–Ω–∏ —Å–∞ –ø—Ä–æ–±–ª–µ–º–∏, –∫–æ–∏—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–∞—Ç –ø–æ–ø—Ä–∞–≤–µ–Ω–∏ –ø—Ä–µ–¥–∏ merge.'
                });
              } else {
                // –û–¥–æ–±—Ä–∏ PR –∞–∫–æ –Ω—è–º–∞ –ø—Ä–æ–±–ª–µ–º–∏
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  event: 'APPROVE',
                  body: '‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω Code Review**\n\n–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏. PR –µ –≥–æ—Ç–æ–≤ –∑–∞ merge.'
                });
              }
            }

  notify-n8n:
    runs-on: ubuntu-latest
    name: –£–≤–µ–¥–æ–º–∏ n8n
    needs: [delegate-to-agents, auto-review]
    env:
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
    
    steps:
      - name: –ò–∑–ø—Ä–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∫—ä–º n8n
        run: |
          curl -X POST "${N8N_WEBHOOK_URL}/webhook/github-pr-status" \
            -H "Content-Type: application/json" \
            -d '{
              "workflow": "pr-automation",
              "status": "completed",
              "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
              "repository": "${{ github.repository }}"
            }'
