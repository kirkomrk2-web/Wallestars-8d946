name: Automated Testing & Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  schedule:
    # –ü—É—Å–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ –Ω–∞ –≤—Å–µ–∫–∏ 30 –º–∏–Ω—É—Ç–∏
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  run-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x, 22.x]
        test-suite: [unit, integration, e2e]
    
    name: –¢–µ—Å—Ç–æ–≤–µ (${{ matrix.test-suite }}) - Node ${{ matrix.node-version }}
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π dependencies
        run: npm ci --legacy-peer-deps

      - name: –ü—É—Å–Ω–∏ ${{ matrix.test-suite }} —Ç–µ—Å—Ç–æ–≤–µ
        run: |
          case "${{ matrix.test-suite }}" in
            unit)
              npm run test:unit || echo "Unit tests not configured"
              ;;
            integration)
              npm run test:integration || echo "Integration tests not configured"
              ;;
            e2e)
              npm run test:e2e || echo "E2E tests not configured"
              ;;
          esac
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}-node-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 30

  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Check
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint || echo "Linting completed with warnings"
        continue-on-error: true

      - name: Check code formatting
        run: npm run format:check || echo "Format check completed"
        continue-on-error: true

      - name: Run type check
        run: npm run type-check || echo "Type check not configured"
        continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scanning
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π dependencies
        run: npm ci --legacy-peer-deps

      - name: Run npm audit
        run: npm audit --audit-level=moderate || echo "Audit completed with warnings"
        continue-on-error: true

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        continue-on-error: true

  build-verification:
    runs-on: ubuntu-latest
    name: Build Verification
    needs: [run-tests, code-quality]
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π dependencies
        run: npm ci --legacy-peer-deps

      - name: Build –∑–∞ production
        run: npm run build

      - name: Verify build artifacts
        run: |
          if [ -d "dist" ]; then
            echo "‚úÖ Build successful - dist directory created"
            ls -lah dist/
          else
            echo "‚ùå Build failed - dist directory not found"
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7

  create-test-session:
    runs-on: ubuntu-latest
    name: –°—ä–∑–¥–∞–π Test Session
    needs: build-verification
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –°—ä–∑–¥–∞–π test session issue
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            
            const sessionBody = [
              `# üß™ Test Session –∑–∞ PR #${prNumber}`,
              '',
              '## PR –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              `- **–ó–∞–≥–ª–∞–≤–∏–µ:** ${prTitle}`,
              `- **–ê–≤—Ç–æ—Ä:** @${context.payload.pull_request.user.login}`,
              `- **URL:** ${context.payload.pull_request.html_url}`,
              '',
              '## Test Checklist',
              '- [ ] Unit —Ç–µ—Å—Ç–æ–≤–µ –ø—Ä–µ–º–∏–Ω–∞—Ç–∏',
              '- [ ] Integration —Ç–µ—Å—Ç–æ–≤–µ –ø—Ä–µ–º–∏–Ω–∞—Ç–∏',
              '- [ ] E2E —Ç–µ—Å—Ç–æ–≤–µ –ø—Ä–µ–º–∏–Ω–∞—Ç–∏',
              '- [ ] Build verification —É—Å–ø–µ—à–Ω–∞',
              '- [ ] Security scan —á–∏—Å—Ç–∞',
              '- [ ] Code quality –æ–¥–æ–±—Ä–µ–Ω–∞',
              '',
              '## –°—Ç–∞—Ç—É—Å',
              'üîÑ **–í –ø—Ä–æ—Ü–µ—Å –Ω–∞ —Ç–µ—Å—Ç–≤–∞–Ω–µ**',
              '',
              '---',
              '_–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—ä–∑–¥–∞–¥–µ–Ω–∞ test session_'
            ].join('\n');
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üß™ Test Session: PR #${prNumber} - ${prTitle}`,
              body: sessionBody,
              labels: ['test-session', 'automated', `pr-${prNumber}`]
            });
            
            // –î–æ–±–∞–≤–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä –∫—ä–º PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `üß™ Test session —Å—ä–∑–¥–∞–¥–µ–Ω–∞: #${issue.number}\n\n–ü—Ä–æ—Å–ª–µ–¥–∏ –ø—Ä–æ–≥—Ä–µ—Å–∞ –Ω–∞ —Ç–µ—Å—Ç–≤–∞–Ω–µ—Ç–æ —Ç–∞–º.`
            });

  notify-results:
    runs-on: ubuntu-latest
    name: –£–≤–µ–¥–æ–º–∏ –∑–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
    needs: [run-tests, code-quality, security-scan, build-verification]
    if: always()
    env:
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
    
    steps:
      - name: –ò–∑–ø—Ä–∞—Ç–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∫—ä–º n8n
        run: |
          curl -X POST "${N8N_WEBHOOK_URL}/webhook/test-results" \
            -H "Content-Type: application/json" \
            -d '{
              "workflow": "testing-automation",
              "tests_passed": "${{ needs.run-tests.result }}",
              "code_quality": "${{ needs.code-quality.result }}",
              "security_scan": "${{ needs.security-scan.result }}",
              "build_verification": "${{ needs.build-verification.result }}",
              "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
              "repository": "${{ github.repository }}",
              "pr_number": "${{ github.event.pull_request.number || 'N/A' }}"
            }'
